<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase Logout Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; padding:20px; }
    .card { background:#1b1b1b; border:1px solid #333; border-radius:8px; padding:16px; max-width:520px; }
    input, button { padding:10px; border-radius:6px; border:1px solid #333; background:#222; color:#eee; }
    button { background:#0bb; border:none; font-weight:600; cursor:pointer; }
    button:hover { background:#099; }
    .row { display:flex; gap:8px; margin-top:10px; }
    #status { margin-top:10px; opacity:.8; }
    code { background:#000; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Supabase Logout Test</h1>
  <div class="card">
    <div><strong>Project:</strong> <code>hvmotpzhliufzomewzfl</code></div>
    <div id="session-line" style="margin-top:8px;">Session: <em>checking…</em></div>

    <div class="row" style="margin-top:12px;">
      <input id="email" type="email" placeholder="email for magic link" style="flex:1;">
      <button id="login">Send Magic Link</button>
    </div>

    <div class="row">
      <button id="refresh-session">Refresh Session</button>
      <button id="logout">Sign Out</button>
      <button id="force-clear" title="Removes sb-<project>-auth-token from localStorage">Force Clear Token</button>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import { supabaseClient as supabase } from './assets/js/supabaseClient.js';

    const PROJECT_REF = 'hvmotpzhliufzomewzfl';
    const sessionLine = document.getElementById('session-line');
    const statusEl    = document.getElementById('status');

    function setStatus(msg, good=true){
      statusEl.textContent = msg;
      statusEl.style.color = good ? '#0bb' : '#ff7a7a';
    }

    async function showSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        sessionLine.innerHTML = `Session: <span style="color:#8f8;">logged in</span> as <code>${session.user.email || session.user.id}</code>`;
      } else {
        sessionLine.innerHTML = 'Session: <span style="color:#f88;">logged out</span>';
      }
    }

    document.getElementById('login').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) return setStatus('Enter an email first.', false);
      setStatus('Sending magic link…');
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href }
      });
      if (error) return setStatus(error.message, false);
      setStatus('Check your inbox for the magic link.');
    });

    document.getElementById('refresh-session').addEventListener('click', showSession);

    document.getElementById('logout').addEventListener('click', async () => {
      setStatus('Signing out…');
      try {
        await supabase.auth.signOut();
        // Clear saved tokens (v2 + legacy)
        localStorage.removeItem(`sb-${PROJECT_REF}-auth-token`);
        localStorage.removeItem('supabase.auth.token');
        await showSession();
        setStatus('Signed out. Reloading page to verify…');
        setTimeout(()=>window.location.reload(), 600);
      } catch (e) {
        console.error(e);
        setStatus('Sign out failed. See console.', false);
      }
    });

    document.getElementById('force-clear').addEventListener('click', async () => {
      localStorage.removeItem(`sb-${PROJECT_REF}-auth-token`);
      localStorage.removeItem('supabase.auth.token');
      setStatus('Local tokens cleared. If you were logged in, refresh session above or reload.');
      await showSession();
    });

    // initial
    showSession();
  </script>
</body>
</html>
