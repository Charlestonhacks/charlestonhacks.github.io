<script>
    (function () {
        const characters = ['astrid', 'medusa', 'alexandor', 'aegis', 'descartes'];
        const backstories = {
            'astrid': 'Astrid - A Valkyrieâ€™s Tale: A powerful warrior with a destiny to save her people.',
            'medusa': 'Medusa - An Otherworldly Force: A feared and misunderstood creature with a tragic past.',
            'alexandor': 'Alexandor - The Strategist: A master tactician who leads armies to victory.',
            'aegis': 'Aegis - The Protector: A shield bearer sworn to guard the realms.',
            'descartes': 'Descartes - A mysterious figure yet to reveal their story.'
        };

        const gameContainer = document.getElementById('game-container');
        const backstoryContainer = document.getElementById('backstory');
        const restartButton = document.getElementById('restart-button');
        const timerDisplay = document.getElementById('timer');
        const movesDisplay = document.getElementById('moves');
        const themeToggle = document.getElementById('theme-toggle');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('video');
        const videoSource = document.getElementById('video-source');

        let flippedCards = [];
        let matchedCards = [];
        let timer = 0;
        let moves = 0;
        let intervalId;

        function startTimer() {
            intervalId = setInterval(() => {
                timer++;
                timerDisplay.textContent = `Time: ${timer}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(intervalId);
        }

        function createCards() {
            const cards = [];
            characters.forEach(character => {
                for (let i = 0; i < 2; i++) {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.dataset.character = character;
                    card.setAttribute('tabindex', '0');
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-front">
                                <img src="images/Front.png" alt="Front of ${character} card">
                            </div>
                            <div class="card-back">
                                <img src="images/${character.charAt(0).toUpperCase() + character.slice(1)}.png" alt="${character} character">
                            </div>
                        </div>
                    `;
                    cards.push(card);
                }
            });
            return cards;
        }

        function shuffleCards() {
            const cards = createCards();
            cards.sort(() => Math.random() - 0.5);
            gameContainer.innerHTML = '';
            cards.forEach(card => gameContainer.appendChild(card));
        }

        function playVideo(character) {
            if (character === 'descartes') {
                videoSource.src = 'images/Descartesvideo.mp4';
            } else if (character === 'medusa') {
                videoSource.src = 'images/Medusavideo.mp4';
            } else if (character === 'alexandor') {
                videoSource.src = 'images/Alexandorvideo.mp4';
            }
            video.load();
            video.muted = true; // Mute the video
            videoContainer.style.display = 'block';
            video.play();
            video.onended = () => {
                videoContainer.style.display = 'none';
            };
        }

        function checkMatch() {
            const [firstCard, secondCard] = flippedCards;
            if (firstCard.dataset.character === secondCard.dataset.character) {
                matchedCards.push(firstCard, secondCard);
                backstoryContainer.textContent = backstories[firstCard.dataset.character];
                backstoryContainer.style.display = 'block';
                firstCard.classList.add('matched');
                secondCard.classList.add('matched');
                flippedCards = [];

                if (matchedCards.length === characters.length * 2) {
                    stopTimer();
                    setTimeout(() => {
                        alert(`You win! Time: ${timer}s, Moves: ${moves}`);
                    }, 500);
                }

                if (firstCard.dataset.character === 'descartes' || firstCard.dataset.character === 'medusa' || firstCard.dataset.character === 'alexandor') {
                    playVideo(firstCard.dataset.character);
                }
            } else {
                setTimeout(() => {
                    firstCard.classList.remove('flipped');
                    secondCard.classList.remove('flipped');
                    flippedCards = [];
                }, 1000);
            }
        }

        function hideBackstory() {
            backstoryContainer.style.display = 'none';
        }

        // Add event listener to hide video when clicked
        videoContainer.addEventListener('click', () => {
            videoContainer.style.display = 'none';
            video.pause();
        });

        gameContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            if (!card || card.classList.contains('flipped') || flippedCards.length >= 2) return;

            hideBackstory();

            card.classList.add('flipped');
            flippedCards.push(card);
            moves++;
            movesDisplay.textContent = `Moves: ${moves}`;

            if (flippedCards.length === 2) checkMatch();
        });

        gameContainer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                const card = document.activeElement;
                if (card && card.classList.contains('card') && !card.classList.contains('flipped')) {
                    card.classList.add('flipped');
                    flippedCards.push(card);
                    moves++;
                    movesDisplay.textContent = `Moves: ${moves}`;

                    if (flippedCards.length === 2) checkMatch();
                }
            }
        });

        restartButton.addEventListener('click', () => {
            matchedCards = [];
            flippedCards = [];
            timer = 0;
            moves = 0;
            timerDisplay.textContent = 'Time: 0s';
            movesDisplay.textContent = 'Moves: 0';
            backstoryContainer.style.display = 'none';
            shuffleCards();
            stopTimer();
            startTimer();
        });

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            document.body.style.backgroundColor = document.body.classList.contains('light-theme') ? 'white' : 'black';
            document.body.style.color = document.body.classList.contains('light-theme') ? 'black' : 'white';
        });

        shuffleCards();
        startTimer();
    })();
</script>
